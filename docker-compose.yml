version: '3.8'

services:
  gateway: 
    image: nginx:stable-alpine
    container_name: gateway
    ports:
      - "80:80"
    volumes:
      - ./gateway/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - identity
      - account
      - payments
      - ledger
      - frontend
      - fraud
    restart: always

  # --- Message Broker ---
  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"   # Main port
      - "15672:15672" # Management UI
    networks:
      - arhan-network

  # --- 1. Identity Service (arhan_financial) ---
  identity:
    build: ./arhan_financial
    env_file:
      - ./.env
    command: python manage.py runserver 0.0.0.0:8001
    volumes:
      - ./arhan_financial:/app
      - ./arhan_financial/Identity_service.sqlite3:/identity/Identity_service.sqlite3
    ports:
      - "8001:8001"
    environment:
      - CELERY_BROKER_URL=amqp://guest:guest@rabbitmq:5672//
    depends_on:
      - rabbitmq
    networks:
      - arhan-network

  identity_worker:
    build: ./arhan_financial
    env_file:
      - ./.env
    command: celery -A arhan_financial worker -l info
    volumes:
      - ./arhan_financial:/app
      - ./arhan_financial/Identity_service.sqlite3:/identity/Identity_service.sqlite3
    environment:
      - CELERY_BROKER_URL=amqp://guest:guest@rabbitmq:5672//
    depends_on:
      - rabbitmq
      - identity
    networks:
      - arhan-network

  # --- 2. Account Service (account_services) ---
  account:
    build: ./account_services
    env_file:
      - ./.env
    command: python manage.py runserver 0.0.0.0:8002
    volumes:
      - ./account_services:/app
      - ./account_services/account_service.sqlite3:/account/account_service.sqlite3
    ports:
      - "8002:8002"
    environment:
      - CELERY_BROKER_URL=amqp://guest:guest@rabbitmq:5672//
      - IDENTITY_SERVICE_URL=http://identity:8001
    depends_on:
      - rabbitmq
    networks:
      - arhan-network

  account_worker:
    build: ./account_services
    env_file:
      - ./.env
    # Note: Using the event router configuration we discussed
    command: celery -A account_services worker -Q account_service.internal,celery -l info
    volumes:
      - ./account_services:/app
      - ./account_services/account_service.sqlite3:/account/account_service.sqlite3
    environment:
      - CELERY_BROKER_URL=amqp://guest:guest@rabbitmq:5672//
    depends_on:
      - rabbitmq
      - account
    networks:
      - arhan-network

  # --- 3. Payments Service (payments) ---
  payments:
    build: ./payments
    env_file:
      - ./.env
    command: python manage.py runserver 0.0.0.0:8004
    volumes:
      - ./payments:/app
      - ./payments/payment.sqlite3:/payment/payment.sqlite3
    ports:
      - "8004:8004"
    environment:
      - CELERY_BROKER_URL=amqp://guest:guest@rabbitmq:5672//
      - ACCOUNT_SERVICE_BASE_URL=http://account:8002
    depends_on:
      - rabbitmq
    networks:
      - arhan-network

  payments_worker:
    build: ./payments
    env_file:
      - ./.env
    # Note: Listening to both payment.internal and default celery queue
    command: celery -A payments worker -Q payment.internal,celery -l info
    volumes:
      - ./payments:/app
      - ./payments/payment.sqlite3:/payment/payment.sqlite3
    environment:
      - CELERY_BROKER_URL=amqp://guest:guest@rabbitmq:5672//
      - ACCOUNT_SERVICE_BASE_URL=http://account:8002
      - FRAUD_SERVICE_URL=http://fraud:8006
    depends_on:
      - rabbitmq
      - payments
      - fraud
    networks:
      - arhan-network

  # --- 4. Ledger Service (ledger_service) ---
  ledger:
    build: ./ledger_service
    env_file:
      - ./.env
    command: python manage.py runserver 0.0.0.0:8003
    volumes:
      - ./ledger_service:/app
      - ./ledger_service/Ledger.sqlite3:/ledger/Ledger.sqlite3
    ports:
      - "8003:8003"
    environment:
      - CELERY_BROKER_URL=amqp://guest:guest@rabbitmq:5672//
    depends_on:
      - rabbitmq
    networks:
      - arhan-network

  ledger_worker:
    build: ./ledger_service
    env_file:
      - ./.env
    command: celery -A ledger_service worker -Q ledger.internal,celery -l info
    volumes:
      - ./ledger_service:/app
      - ./ledger_service/Ledger.sqlite3:/ledger/Ledger.sqlite3
    environment:
      - CELERY_BROKER_URL=amqp://guest:guest@rabbitmq:5672//
    depends_on:
      - rabbitmq
      - ledger
    networks:
      - arhan-network


  # --- 5. Frontend Service (frontend_service) ---
  frontend:
    build: ./frontend_service
    env_file:
      - ./.env
    command: sh -c "python manage.py collectstatic --noinput && python manage.py runserver 0.0.0.0:8005"
    volumes:
      - ./frontend_service:/app
      - ./frontend_service/frontend_service.sqlite3:/frontend/frontend_service.sqlite3
    ports:
      - "8005:8005"
    environment:
      - CELERY_BROKER_URL=amqp://guest:guest@rabbitmq:5672//
    networks:
      - arhan-network


  # --- 6. Fraud Service (fraud_service) ---
  fraud:
    build: ./fraud_service
    command: uvicorn app.main:app --host 0.0.0.0 --port 8006 --reload
    volumes:
      - ./fraud_service:/app
    ports:
      - "8006:8006"
    networks:
      - arhan-network


networks:
  arhan-network:
    driver: bridge

  