events {}

http {
    include mime.types;
    resolver 127.0.0.11 valid=30s;

    # 1. Redirect HTTP -> HTTPS
    server {
        listen 80;
        server_name arhan-financial.duckdns.org;

        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        location / {
            return 301 https://$host$request_uri;
        }
    }

    # 2. HTTPS Server (The Main Event)
    server {
        listen 443 ssl;
        server_name arhan-financial.duckdns.org;

        # ğŸ›¡ï¸ SSL Certificates (Ensure path matches the DuckDNS name)
        ssl_certificate /etc/letsencrypt/live/arhan-financial.duckdns.org/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/arhan-financial.duckdns.org/privkey.pem;

        # ğŸ›¡ï¸ Security Hardening
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers HIGH:!aNULL:!MD5;

        # Standard Proxy Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;

        # --- ROUTING ---

        # ğŸ–¥ï¸ Frontend (BFF)
        location / {
            set $frontend_upstream http://frontend:8005;
            proxy_pass $frontend_upstream;
        }

        # ğŸ†” Identity API
        location /api/identity/ {
            set $identity_upstream http://identity:8001;
            proxy_pass $identity_upstream/;
        }

        # ğŸ’³ Account API
        location /api/account/ {
            set $account_upstream http://account:8002;
            proxy_pass $account_upstream/;
        }

        # ğŸ’¸ Payment API
        location /api/payment/ {
            set $payment_upstream http://payments:8003;
            proxy_pass $payment_upstream/;
        }

        # ğŸ•µï¸ Fraud Service (Optional: Expose for testing if needed)
        location /api/fraud/ {
            set $fraud_upstream http://fraud:8006;
            proxy_pass $fraud_upstream/;
        }
    }
}